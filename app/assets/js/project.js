const ipcRenderer=require("electron").ipcRenderer,low=require("lowdb"),FileSync=require("lowdb/adapters/FileSync"),settings=require("electron-settings"),handlebars=require("handlebars"),i18n=require("i18n"),moment=require("moment"),package=require(__dirname+"/../../package.json"),os=require("os");let db=low(new FileSync(os.homedir()+"/Documents/todolist-electron/project_list.json")),project_id=ipcRenderer.sendSync("getproject"),project_info=db.get("projects").filter({id:project_id}).value()[0];i18n.configure({directory:__dirname+"/../locales/"+settings.get("lang")+"/"}),handlebars.registerHelper("i18n",function(e){return i18n.__({phrase:e,locale:"project"})});let template=handlebars.compile(document.documentElement.innerHTML);function UpdateDateProject(){let e=moment().format("DD-MM-YYYY à HH:mm");db.get("projects").find({id:project_id}).assign({date_lastup:e}).write()}document.documentElement.innerHTML=template(),document.title+=" ("+project_info.title+") [v"+package.version+"]",$("#config > p").prepend(project_info.title),$("#config > p > small").html(project_info.desc),$("#BtnHome").click(function(e){e.preventDefault(),ipcRenderer.send("change-page",{name:"home"})}),$(".edit-project").click(function(e){return e.preventDefault(),$("#inputName").val(project_info.title),$("#inputDescP").summernote("code",project_info.desc),$("#ModalEditProject").modal("show"),!1}),$(".add_taskopenmodal").click(function(e){return e.preventDefault(),$(".add_task").find("#inputDescr").summernote(),$("#ModalAddTask").modal("show"),!1}),$(".close-modal").click(function(){var e=$(this).parents(".modal").attr("id");$("#"+e).modal("hide")}),$(".EditProject-modal").click(function(e){e.preventDefault(),$("#inputDescP").summernote();let t=$("#inputName").val(),a=$("#inputDescP").summernote("code");return t&&(db.get("projects").find({title:project_info.title}).assign({title:t,desc:a}).write(),UpdateDateProject(),$("#ModalEditProject").modal("hide")),!1}),$(".addTask-modal").click(function(e){e.preventDefault();let t=$(".add_task").find("#inputTitre"),a=$(".add_task").find("#inputType"),s=$(".add_task").find("#inputDateFinish"),i=$(".add_task").find("#inputDest"),r=$(".add_task").find("#inputDescr"),d=t.val(),l=a.val(),o=s.val(),n=i.val(),c=r.summernote("code"),p=moment().format("DD-MM-YYYY à HH:mm"),u=0;if(db.get("projects_info").size().value()>0){u=db.get("projects_info").takeRight(1).value()[0].id+1}else u=1;return d&&l&&(db.get("projects_info").push({id:u,projectId:project_id,title:d,date_create:p,type:l,dest:n,desc:c,date_finish:o,progress:0,close:!1}).write(),UpdateDateProject(),$(".list_task").prepend('<tr data-toggle="collapse" data-target=".collapse_info_'+u+'" class="table-light" data-taskId="'+u+'"><th scope="row">'+u+"</th><td>"+d+"</td><td>"+l+'</td><td><div class="progress"><div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0 %</div></div></td><td style="text-align: center;"><i class="fa fa-pencil-square-o edit-task" aria-hidden="true"></i><i class="fa fa-trash delete-task" aria-hidden="true"></i><i class="fa fa-check-square-o close-task" aria-hidden="true"></i></td></tr><tr><td colspan="4" class="hiddenRow"><div class="collapse collapse_info_'+u+'"><div class="info_task_col">'+c+"</div></div></td></tr>"),t.val(""),a.val(""),s.val(""),i.val(""),r.val(""),$("#ModalAddTask").modal("hide")),!1}),$.each(db.get("projects_info").filter({projectId:project_id}).sortBy("id").reverse().sortBy("close").reverse().value(),function(e,t){let a="",s="";t.close?(a="table-success",s=100):(a="table-light",s=t.progress),$(".list_task").prepend('<tr data-toggle="collapse" data-target=".collapse_info_'+t.id+'" class="'+a+'" data-taskId="'+t.id+'"><th scope="row">'+t.id+"</th><td>"+t.title+"</td><td>"+t.type+'</td><td><div class="progress"><div class="progress-bar" role="progressbar" style="width: '+s+'%;" aria-valuenow="'+t.progress+'" aria-valuemin="0" aria-valuemax="100">'+s+' %</div></div></td><td style="text-align: center;"><i class="fa fa-pencil-square-o edit-task" aria-hidden="true"></i><i class="fa fa-trash delete-task" aria-hidden="true"></i><i class="fa fa-check-square-o close-task" aria-hidden="true"></i></td></tr><tr><td colspan="5" class="hiddenRow"><div class="collapse collapse_info_'+t.id+'"><div class="info_task_col">'+t.desc+"</div></div></td></tr>")}),$(".collapse").on("show.bs.collapse",function(){$(".collapse.show").collapse("hide")}),$(".close-task").click(function(){let e=$(this).parents("tr").data("taskid");if(db.get("projects_info").filter({id:e}).value()[0].close){db.get("projects_info").find({id:e}).assign({close:!1}).write(),console.log($(this).parents("tr").find(".progress-bar").attr("aria-valuenow"));let t=$(this).parents("tr").find(".progress-bar").attr("aria-valuenow");$(this).parents("tr").find(".progress-bar").css("width",t+"%").html(t+"%"),$(this).parents("tr").removeClass("table-success").addClass("table-light")}else db.get("projects_info").find({id:e}).assign({close:!0}).write(),$(this).parents("tr").removeClass("table-light").addClass("table-success"),$(this).parents("tr").find(".progress-bar").css("width","100%").html("100%");UpdateDateProject()}),$(".edit-task").click(function(){let e=$(this).parents("tr").data("taskid"),t=db.get("projects_info").filter({id:e}).value()[0];$("#ModalUpdateTask").modal("show");let a=$(".update_task").find("#inputTitre"),s=$(".update_task").find("#inputType"),i=$(".update_task").find("#inputDateFinish"),r=$(".update_task").find("#inputDest"),d=$(".update_task").find("#inputDescr"),l=$(".update_task").find("#inputProgress"),o=!1;d.summernote(),$("#ModalUpdateTask").on("shown.bs.modal",function(e){a.val(t.title),s.val(t.type),i.val(t.date_finish),r.val(t.dest),d.summernote("code",t.desc),l.val(t.progress)}),$(".UpdateTask-modal").click(function(){100==l.val()&&(o=!0),db.get("projects_info").find({id:e}).assign({title:a.val(),type:s.val(),dest:r.val(),desc:d.summernote("code"),date_finish:i.val(),progress:l.val(),close:o}).write(),UpdateDateProject(),$("#ModalUpdateTask").modal("hide")}),$("#ModalUpdateTask").on("hidden.bs.modal",function(e){a.val(""),s.val(""),i.val(""),r.val(""),d.val(""),l.val("")})}),$(".delete-task").click(function(){let e=$(this).parents("tr").data("taskid");$(this).parents("tr").remove(),$(".collapse_info_"+e).parents("tr").remove(),db.get("projects_info").remove({id:e}).write()});let fetchStyle=function(e){return new Promise((t,a)=>{let s=document.createElement("link");s.type="text/css",s.rel="stylesheet",s.onload=function(){t()},s.href="../assets/css/theme/"+e+".css";let i=document.querySelector("script");i.parentNode.insertBefore(s,i)})};fetchStyle(settings.get("theme"));